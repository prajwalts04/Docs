<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbyn6zw19HiWmt58b4YTOhN28lNU9s13cel0BnAEHHztSBzjSuTfuN6R5p34BEtsyIOTqA/exec";

// --- CORE VALIDATION AND BUTTON CHECK ---
function check() {
  const name = document.getElementById("name").value.trim();
  const contact = document.getElementById("contact").value.trim();
  const fileSelected = document.getElementById("file").files.length > 0;
  
  // Enable button only if both fields are non-empty and a file is selected
  document.getElementById("uploadBtn").disabled = !(name.length > 0 && contact.length > 0 && fileSelected);
}

// --- EVENT LISTENERS INITIALIZATION (Fixes Validation Display) ---
document.addEventListener('DOMContentLoaded', () => {
    const nameInput = document.getElementById('name');
    const contactInput = document.getElementById('contact');
    const fileInput = document.getElementById('file');
    
    // Function to handle error display on blur (losing focus)
    const handleValidation = (input, errorId) => {
        const errorElement = document.getElementById(errorId);
        
        // 1. Check for button status on every change (input event)
        input.addEventListener('input', () => {
            check();
            // Hide the error immediately if user starts typing after it was shown
            if (input.value.trim().length > 0) {
                 errorElement.style.display = 'none';
            }
        });
        
        // 2. Show the error only when the field is left empty (blur event)
        input.addEventListener('blur', () => {
            if (input.value.trim().length === 0) {
                errorElement.style.display = 'block';
            } else {
                errorElement.style.display = 'none';
            }
        });
    };

    // Attach listeners
    handleValidation(nameInput, 'nameErr');
    handleValidation(contactInput, 'contactErr');
    fileInput.addEventListener('change', check); // Check button status when file selected
    
    // Initial check to disable button on load
    check();
});


// --- UPLOAD FUNCTION (Fixes Speed/Progress Display) ---
async function upload() {
  const name = document.getElementById("name").value.trim();
  const contact = document.getElementById("contact").value.trim();
  const file = document.getElementById("file").files[0];
  const progressBar = document.getElementById("progressBar");
  const statusText = document.getElementById("statusText");
  const msgDiv = document.getElementById("msg");

  // Input check is necessary before starting the UI process
  if (!name || !contact || !file) {
      alert("Please fill in all required fields and select a PDF.");
      return;
  }

  // --- PROGRESS BAR INITIALIZATION (Ensures progress is visible) ---
  document.getElementById("progressArea").style.display = "block";
  msgDiv.innerHTML = "";
  
  // Explicitly set the initial state to 0%
  progressBar.style.background = "#ffc107";
  progressBar.style.width = "0%";
  statusText.innerText = "Preparing upload..."; 
  
  let progress = 0;
  let fake = setInterval(() => {
    progress = Math.min(progress + Math.random() * 5, 95); 
    progressBar.style.width = progress + "%";
    statusText.innerText = "Uploading... " + Math.round(progress) + "%";
    if (progress >= 95) clearInterval(fake);
  }, 150);

  try {
    const base64 = await toBase64(file);
    
    // Update status while waiting for server response
    statusText.innerText = "Sending data to server..."; 

    const response = await fetch(scriptURL, {
      method: "POST",
      body: JSON.stringify({
        name: name,
        contact: contact,
        file: base64
      })
    });

    const msg = await response.text();
    
    // SUCCESS STATE
    clearInterval(fake);
    progressBar.style.background = "#28a745"; 
    progressBar.style.width = "100%";
    statusText.innerText = "Upload Complete ✔";
    msgDiv.innerHTML = msg;
    
  } catch(err) {
    // FAILURE STATE
    clearInterval(fake);
    progressBar.style.background = "#dc3545";
    progressBar.style.width = "100%";
    statusText.innerText = "Upload Failed ❌";
    msgDiv.innerHTML = "Upload Failed ❌<br>" + err;
  }
}

function toBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(",")[1]);
    reader.onerror = error => reject(error);
    reader.readAsDataURL(file);
  });
}
</script>
