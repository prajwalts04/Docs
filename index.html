<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbyn6zw19HiWmt58b4YTOhN28lNU9s13cel0BnAEHHztSBzjSuTfuN6R5p34BEtsyIOTqA/exec";

// --- CORE VALIDATION AND BUTTON CHECK ---
function check() {
  const name = document.getElementById("name").value.trim();
  const contact = document.getElementById("contact").value.trim();
  const fileSelected = document.getElementById("file").files.length > 0;
  
  // Custom contact number validation: must contain at least 10 digits
  const isContactValid = contact.replace(/\D/g, '').length >= 10;
  
  // Enable button only if all fields are non-empty AND contact is valid
  document.getElementById("uploadBtn").disabled = !(name.length > 0 && isContactValid && fileSelected);
  
  // Note: We don't change error visibility here, that's handled by event listeners below.
}

// --- EVENT LISTENERS INITIALIZATION (Validation logic) ---
document.addEventListener('DOMContentLoaded', () => {
    const nameInput = document.getElementById('name');
    const contactInput = document.getElementById('contact');
    const fileInput = document.getElementById('file');
    const nameErr = document.getElementById('nameErr');
    const contactErr = document.getElementById('contactErr');
    
    // Update the error message for contact validation
    contactErr.innerText = "Contact number must be at least 10 digits.";

    // Generic function to set up listeners for an input field
    const setupInputListeners = (input, errorElement, validationFn) => {
        // 1. Check for button status on every change (input event)
        input.addEventListener('input', () => {
            check();
            // Hide the error immediately if user starts typing after it was shown
            if (validationFn(input.value.trim())) {
                 errorElement.style.display = 'none';
            }
        });
        
        // 2. Show the error only when the field is left empty OR invalid (blur event)
        input.addEventListener('blur', () => {
            if (!validationFn(input.value.trim())) {
                errorElement.style.display = 'block';
            } else {
                errorElement.style.display = 'none';
            }
        });
    };
    
    // Validation functions
    const isNameValid = (value) => value.length > 0;
    const isContactFormatValid = (value) => value.replace(/\D/g, '').length >= 10;

    // Attach listeners
    setupInputListeners(nameInput, nameErr, isNameValid);
    setupInputListeners(contactInput, contactErr, isContactFormatValid);
    fileInput.addEventListener('change', check); 
    
    // Initial check to disable button on load
    check();
});


// --- UPLOAD FUNCTION (Enhanced Speed/Progress logic) ---
async function upload() {
  const name = document.getElementById("name").value.trim();
  const contact = document.getElementById("contact").value.trim();
  const file = document.getElementById("file").files[0];
  const progressBar = document.getElementById("progressBar");
  const statusText = document.getElementById("statusText");
  const msgDiv = document.getElementById("msg");

  // Input check for safety
  if (!name || contact.replace(/\D/g, '').length < 10 || !file) {
      // Re-trigger visual validation errors if the upload button was clicked prematurely
      document.getElementById('nameErr').style.display = name ? 'none' : 'block';
      document.getElementById('contactErr').style.display = contact.replace(/\D/g, '').length < 10 ? 'block' : 'none';
      alert("Please ensure all fields are filled correctly, including a 10-digit contact number.");
      return;
  }

  // --- PROGRESS BAR INITIALIZATION (Ensures progress is visible) ---
  document.getElementById("progressArea").style.display = "block";
  msgDiv.innerHTML = "";
  
  progressBar.style.background = "#ffaa00"; // Orange
  progressBar.style.width = "0%";
  statusText.innerText = "1. Starting Base64 conversion..."; // Explicit status step 1
  
  let progress = 0;
  let fake = setInterval(() => {
    // Fake progress runs until 95%
    progress = Math.min(progress + Math.random() * 5, 95); 
    progressBar.style.width = progress + "%";
    statusText.innerText = `2. Uploading Data... ${Math.round(progress)}%`; // Explicit status step 2
    if (progress >= 95) clearInterval(fake);
  }, 150);

  try {
    const base64 = await toBase64(file);
    
    // Status update while waiting for server response
    statusText.innerText = "3. Awaiting Server Response..."; // Explicit status step 3

    const response = await fetch(scriptURL, {
      method: "POST",
      body: JSON.stringify({
        name: name,
        contact: contact,
        file: base64
      })
    });

    const msg = await response.text();
    
    // SUCCESS STATE 
    clearInterval(fake);
    progressBar.style.background = "#00cc00"; // Success Green
    progressBar.style.width = "100%";
    statusText.innerText = "Upload Complete ✔";
    msgDiv.innerHTML = msg;
    
  } catch(err) {
    // FAILURE STATE
    clearInterval(fake);
    progressBar.style.background = "#cc0000"; // Error Red
    progressBar.style.width = "100%";
    statusText.innerText = "Upload Failed ❌";
    msgDiv.innerHTML = "Upload Failed ❌<br>" + err;
  }
}

function toBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(",")[1]);
    reader.onerror = error => reject(error);
    reader.readAsDataURL(file);
  });
}
</script>
