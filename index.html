<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbyn6zw19HiWmt58b4YTOhN28lNU9s13cel0BnAEHHztSBzjSuTfuN6R5p34BEtsyIOTqA/exec";

// Function to check validation and enable/disable button
function check() {
  const nameInput = document.getElementById("name");
  const contactInput = document.getElementById("contact");
  const fileInput = document.getElementById("file");
  
  const name = nameInput.value.trim();
  const contact = contactInput.value.trim();
  const fileSelected = fileInput.files.length > 0;

  // Only show errors if the field is empty AND has been interacted with (or is currently focused)
  const isNameValid = name.length > 0;
  const isContactValid = contact.length > 0;
  
  // Hide all error messages initially or when valid
  document.getElementById("nameErr").style.display = "none";
  document.getElementById("contactErr").style.display = "none";

  // Re-enable the button if all criteria are met
  document.getElementById("uploadBtn").disabled = !(isNameValid && isContactValid && fileSelected);
}

// Function to show individual field errors if the field is invalid and has lost focus
function validateField(inputElement, errorElementId, validationFn) {
    inputElement.addEventListener('blur', () => {
        const errorElement = document.getElementById(errorElementId);
        if (validationFn(inputElement.value.trim())) {
            errorElement.style.display = 'none';
        } else {
            errorElement.style.display = 'block';
        }
    });
}

// Attach the validation listeners to trigger on blur (when field loses focus)
document.addEventListener('DOMContentLoaded', () => {
    validateField(document.getElementById('name'), 'nameErr', value => value.length > 0);
    validateField(document.getElementById('contact'), 'contactErr', value => value.length > 0);
    
    // Initial check to disable button
    check();
});


async function upload() {
  const name = document.getElementById("name").value.trim();
  const contact = document.getElementById("contact").value.trim();
  const file = document.getElementById("file").files[0];
  const progressBar = document.getElementById("progressBar");
  const statusText = document.getElementById("statusText");
  const msgDiv = document.getElementById("msg");

  document.getElementById("progressArea").style.display = "block";
  msgDiv.innerHTML = "";
  
  // Reset initial progress
  progressBar.style.background = "#ffc107"; // Yellow/Orange
  progressBar.style.width = "0%";
  statusText.innerText = "Preparing upload...";
  
  let progress = 0;
  let fake = setInterval(() => {
    // Progress bar moves until 95% while waiting for I/O operations
    progress = Math.min(progress + Math.random() * 5, 95); 
    progressBar.style.width = progress + "%";
    statusText.innerText = "Uploading... " + Math.round(progress) + "%";
    if (progress >= 95) clearInterval(fake);
  }, 150);

  try {
    const base64 = await toBase64(file);

    // After base64 conversion (which can take time for large files), update status
    statusText.innerText = "Sending data to server..."; 

    const response = await fetch(scriptURL, {
      method: "POST",
      body: JSON.stringify({
        name: name,
        contact: contact,
        file: base64
      })
    });

    const msg = await response.text();
    
    // --- SUCCESS STATE: This runs ONLY after the fetch request and server response ---
    clearInterval(fake);
    progressBar.style.background = "#28a745"; // Success Green
    progressBar.style.width = "100%";
    statusText.innerText = "Upload Complete ✔";
    msgDiv.innerHTML = msg; // This will show "Uploaded successfully" or the server's response
    
  } catch(err) {
    // --- FAILURE STATE ---
    clearInterval(fake);
    progressBar.style.background = "#dc3545"; // Error Red
    progressBar.style.width = "100%";
    statusText.innerText = "Upload Failed ❌";
    msgDiv.innerHTML = "Upload Failed ❌<br>" + err;
  }
}

function toBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(",")[1]);
    reader.onerror = error => reject(error);
    reader.readAsDataURL(file);
  });
}
</script>
